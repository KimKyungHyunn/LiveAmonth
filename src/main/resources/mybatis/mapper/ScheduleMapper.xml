<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper 
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<mapper namespace="com.liveamonth.liveamonth.model.mapper.scheduleMapper.ScheduleMapper">
	<!-- select -->
	<select id="beforeScheduleAddSearch" parameterType="ScheduleContentVO" resultType="int">
		select count(*) from scheduleContent where scheduleContentDate = #{scheduleContentDate}
	</select>

	<select id="scheduleContentList" parameterType="HashMap" resultType="ScheduleContentVO">
		select * from scheduleContent where scheduleContent.scheduleNO = #{scheduleNO} AND scheduleContentDate &gt;= #{calendarDTO.dbStartDate} and scheduleContentDate &lt;= #{calendarDTO.dbEndDate} order by scheduleContentDate, scheduleContentNO
	</select>

	<select id="getLastScheduleContentNO" resultType="int">
		select max(scheduleContentNO) from scheduleContent;
	</select>


	<select id="getMaxScheduleNO" resultType="int">
		select max(scheduleNO) from schedule;
	</select>

	<select id="getScheduleList" resultType="ScheduleVO" parameterType="int">
		select * from schedule where userNO = #{userNO};
	</select>


	<resultMap type = "java.util.HashMap" id="scheduleFilterAndOrder">
		<id column="scheduleNO" property="scheduleNO"/>
		<result column="scheduleSubject" property="scheduleSubject"/>
		<result column="schedulePlace" property="schedulePlace"/>
		<result column="scheduleViewCount" property="scheduleViewCount"/>
		<result column="scheduleLikeCount" property="scheduleLikeCount"/>
		<association property="userVO" javaType="userVO">
			<id column="userNO" property="userNO"/>
			<result column="userNickname" property="userNickname"/>
			<result column="userAge" property="userAge"/>
			<result column="userSex" property="userSex"/>
		</association>
	</resultMap>

 	<select id="getOtherScheduleList" parameterType="HashMap" resultMap="scheduleFilterAndOrder">
		select schedule.scheduleNO, user.userNO, userNickname, scheduleSubject,(Year(curdate())-user.userAge) as userAge,userSex,schedulePlace,scheduleViewCount,COUNT(scheduleLike.scheduleNO) as scheduleLikeCount
		from user, schedule, scheduleLike
		where user.userNO = schedule.userNO
		and schedule.scheduleNO = scheduleLike.scheduleNO
		<if test="userAgeFilter">
			and Year(curdate())-user.userAge between #{userAge} and #{userAge}+9
		</if>
		<if test="userSexFilter">
			and userSex = #{userSex}
		</if>
		<if test="schedulePlaceFilter">
			and schedulePlace = #{schedulePlace}
		</if>
		GROUP BY schedule.scheduleNO
		<choose>
			<when test="orderBy == 'orderByView'">
				ORDER BY schedule.scheduleViewCount desc;
			</when>
			<when test="orderBy == 'orderByLiked'">
				ORDER BY COUNT(scheduleLike.scheduleNO) desc;
			</when>
			<when test="orderBy == 'orderByNew'">
				ORDER BY schedule.scheduleNO desc;
			</when>
			<otherwise>
				AND schedule.scheduleStatus = true
			</otherwise>
		</choose>
	</select>

	<resultMap type = "java.util.HashMap" id="scheduleReplyAndNickname">
		<id column="NO" property="NO"/>
		<result column="userNickname" property="userNickname"/>
		<association property="scheduleReply" javaType="ScheduleReplyVO">
			<id column="scheduleReplyNO" property="scheduleReplyNO"/>
			<result column="scheduleReplyDesc" property="scheduleReplyDesc"/>
			<result column="scheduleReplyDate" property="scheduleReplyDate"/>
			<result column="scheduleReplyRefNO" property="scheduleReplyRefNO"/>
			<result column="userNO" property="userNO"/>
			<result column="scheduleNO" property="scheduleNO"/>
		</association>
	</resultMap>

	<select id="getScheduleReplyList" parameterType="java.util.HashMap" resultMap="scheduleReplyAndNickname">
		select @rownum:=@rownum+1 as NO, sortScheduleReply.* from
			(select IF(scheduleReplyRefNO >= 0, scheduleReplyRefNO, scheduleReplyNO) as sortScheduleReplyNO, scheduleReply.*, userNickName
				from scheduleReply, user where scheduleReply.userNO = user.userNO AND scheduleNO= #{scheduleNO} order by sortScheduleReplyNO, scheduleReplyNO) sortScheduleReply,
		   	(select @rownum:=#{startNO})TMP
		limit #{startNO}, #{displayPage};
	</select>

	<select id="getMaxScheduleReplyNO" resultType="int">
		select max(scheduleReplyNO) from scheduleReply;
	</select>

	<select id="getScheduleReplyCount" parameterType="int" resultType="int">
		select count(scheduleReplyNO) as count from scheduleReply where scheduleNO = #{scheduleNO};
	</select>

	<select id="getScheduleLikeStatus" parameterType="com.liveamonth.liveamonth.entity.vo.ScheduleLikeVO" resultType="int">
		select EXISTS (select * from scheduleLike where scheduleNO = #{scheduleNO} and scheduleLikeUserNO =  #{scheduleLikeUserNO}) as success;
	</select>

	<select id ="getScheduleLikeCount" parameterType="int" resultType="int">
		select count(scheduleNO) as count from scheduleLike where scheduleNO = #{scheduleNO};
	</select>

	<resultMap type = "java.util.HashMap" id="scheduleAndLikeCount">
		<id column="scheduleNO" property="scheduleNO"/>
		<result column="scheduleViewCount" property="scheduleViewCount"/>
		<result column="likeCount" property="likeCount"/>
	</resultMap>
	<select id ="getScheduleAndLikeCount" parameterType="int" resultMap="scheduleAndLikeCount">
		select schedule.scheduleNO, scheduleViewCount, count(scheduleLikeUserNO) as likeCount from schedule, scheduleLike where schedule.scheduleNO = scheduleLike.scheduleNO and schedule.scheduleNO = #{scheduleNO} group by schedule.scheduleNO;
	</select>

	<!-- delete -->
	<delete id="deleteScheduleContent" parameterType="int">
		delete from scheduleContent where scheduleContentNO = #{scheduleContentNO}
	</delete>
	
	<delete id="deleteSchedule" parameterType="int">
		delete from schedule where scheduleNO = #{scheduleNO}
	</delete>

	<delete id="deleteScheduleReply" parameterType="int">
		delete from scheduleReply where scheduleReplyNO = #{scheduleReplyNO}
	</delete>

	<delete id="deleteScheduleLike" parameterType="com.liveamonth.liveamonth.entity.vo.ScheduleLikeVO">
		delete from scheduleLike where scheduleNO = #{scheduleNO} AND scheduleLikeUserNO = #{scheduleLikeUserNO};
	</delete>

	<!-- insert -->

	<insert id="addSchedule" parameterType="ScheduleVO">
		insert into schedule values(#{scheduleNO}, #{scheduleSubject}, #{scheduleStatus}, #{schedulePlace},#{scheduleViewCount},#{userNO})
	</insert>

	<insert id="addScheduleContent" parameterType="ScheduleContentVO">
		insert into scheduleContent values (#{scheduleContentNO}, #{scheduleContentSubject}, #{scheduleContentDesc}, #{scheduleContentDate}, #{scheduleContentCost}, #{scheduleNO})
	</insert>

	<insert id="addScheduleReplyVO" parameterType="ScheduleReplyVO">
		insert into scheduleReply values (#{scheduleReplyNO}, #{scheduleReplyDesc}, #{scheduleReplyDate},
		<choose>
			<when test = "scheduleReplyRefNO == 0">
				null
			</when>
			<otherwise>
				#{scheduleReplyRefNO}
			</otherwise>
		</choose>
		, #{userNO}, #{scheduleNO})
	</insert>

	<insert id="addScheduleLike" parameterType="com.liveamonth.liveamonth.entity.vo.ScheduleLikeVO">
		insert into scheduleLike values (#{scheduleNO}, #{scheduleLikeUserNO})
	</insert>

	<!-- update -->

	<update id="modifyScheduleContent" parameterType="ScheduleContentVO">
		update scheduleContent
		set scheduleContentSubject = #{scheduleContentSubject}, scheduleContentDesc = #{scheduleContentDesc},
		scheduleContentCost = #{scheduleContentCost}
		where scheduleContentNO = #{scheduleContentNO}
	</update>
	
	<update id="modifySchedule" parameterType="ScheduleVO">
		update schedule set scheduleSubject = #{scheduleSubject}, scheduleStatus = #{scheduleStatus}, schedulePlace = #{schedulePlace} where scheduleNO = #{scheduleNO}
	</update>

	<update id="modifyScheduleReply" parameterType="ScheduleReplyVO">
		update scheduleReply set scheduleReplyDesc = #{scheduleReplyDesc} where scheduleReplyNO = #{scheduleReplyNO}
	</update>

	<update id="increaseScheduleViewCount" parameterType="int">
		update schedule set scheduleViewCount = scheduleViewCount + 1 where scheduleNO = #{scheduleNO};
	</update>
</mapper>